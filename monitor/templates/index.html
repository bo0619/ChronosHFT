<!-- file: monitor/templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChronosHFT Live Dashboard</title>
    <!-- 使用更稳定的 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { background-color: #0b0e11; color: #eaecef; font-family: 'Roboto', sans-serif; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2b2f36; padding-bottom: 15px; margin-bottom: 20px; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; transition: all 0.3s; }
        .status-online { background: #02c076; color: #fff; }
        .status-offline { background: #cf304a; color: #fff; }
        .grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        .card { background: #1e2329; border-radius: 8px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .metric-label { color: #848e9c; font-size: 14px; margin-bottom: 8px; }
        .metric-value { font-size: 28px; font-weight: 600; font-family: 'Consolas', monospace; }
        #chart-container { width: 100%; height: 450px; }
        #logs { font-size: 11px; color: #848e9c; height: 250px; overflow-y: auto; border-top: 1px solid #2b2f36; padding-top: 10px; }
        .green { color: #02c076; } .red { color: #cf304a; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ChronosHFT Live Monitor</h1>
        <span id="conn-status" class="badge status-offline">DISCONNECTED</span>
    </div>

    <div class="grid">
        <div class="card">
            <div style="margin-bottom: 25px;">
                <div class="metric-label">DYNAMIC EQUITY (USDT)</div>
                <div id="equity" class="metric-value">--</div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div>
                    <div class="metric-label">BALANCE</div>
                    <div id="balance" style="font-size: 16px; font-weight: bold;">--</div>
                </div>
                <div>
                    <div class="metric-label">MARGIN</div>
                    <div id="margin" style="font-size: 16px; font-weight: bold;">--</div>
                </div>
            </div>
            <div class="metric-label">SYSTEM LOGS</div>
            <div id="logs"></div>
        </div>

        <div class="card">
            <div class="metric-label">EQUITY CURVE</div>
            <div id="chart-container"></div>
        </div>
    </div>

    <script>
        let chart, series;

        function initChart() {
            try {
                const container = document.getElementById('chart-container');
                chart = LightweightCharts.createChart(container, {
                    layout: { background: { color: '#1e2329' }, textColor: '#d1d4dc' },
                    grid: { vertLines: { color: '#2b2f36' }, horzLines: { color: '#2b2f36' } },
                    timeScale: { timeVisible: true, secondsVisible: true },
                    rightPriceScale: { borderVisible: false }
                });
                
                // 修复：确保调用正确的方法
                series = chart.addAreaSeries({
                    topColor: 'rgba(2, 192, 118, 0.4)',
                    bottomColor: 'rgba(2, 192, 118, 0.0)',
                    lineColor: '#02c076',
                    lineWidth: 2,
                });

                window.addEventListener('resize', () => {
                    chart.applyOptions({ width: container.clientWidth });
                });
                console.log("Chart initialized successfully.");
            } catch (e) {
                console.error("Chart initialization failed:", e);
            }
        }

        function connect() {
            const wsUrl = (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws';
            const ws = new WebSocket(wsUrl);
            const statusBadge = document.getElementById('conn-status');

            ws.onopen = () => {
                statusBadge.innerText = "LIVE CONNECTED";
                statusBadge.className = "badge status-online";
                console.log("WebSocket connected to:", wsUrl);
            };

            ws.onclose = () => {
                statusBadge.innerText = "DISCONNECTED";
                statusBadge.className = "badge status-offline";
                setTimeout(connect, 3000);
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === 'pnl') {
                    const d = msg.data;
                    document.getElementById('equity').innerText = d.equity.toFixed(2);
                    document.getElementById('equity').className = d.equity >= d.balance ? 'metric-value green' : 'metric-value red';
                    document.getElementById('balance').innerText = d.balance.toFixed(2);
                    document.getElementById('margin').innerText = d.margin.toFixed(2);
                    
                    if (series) {
                        series.update({
                            time: Math.floor(d.timestamp),
                            value: d.equity
                        });
                    }
                } else if (msg.type === 'log') {
                    const logBox = document.getElementById('logs');
                    const div = document.createElement('div');
                    div.style.marginBottom = '4px';
                    div.innerText = `[${new Date().toLocaleTimeString()}] ${msg.data}`;
                    logBox.prepend(div);
                }
            };

            ws.onerror = (err) => console.error("WebSocket Error:", err);
        }

        // 确保所有资源加载后再执行
        window.onload = () => {
            initChart();
            connect();
        };
    </script>
</body>
</html>